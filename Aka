#!/usr/bin/env bash
set -euo pipefail
CLIENT_TOKEN="akab-REPLACE_ME"
CLIENT_SECRET="REPLACE_ME_BASE64_SECRET"
ACCESS_TOKEN="akab-REPLACE_ME"
HOST="your-subdomain.luna.akamaiapis.net"
EVENT_PATH="/event-viewer-api/v1/events"
PRODUCT="WAF"
TIME_WINDOW_MINUTES=5
OUT_PREFIX="akamai_events"
OUT_DIR="."
END_ISO="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
START_ISO="$(date -u -d "-${TIME_WINDOW_MINUTES} minutes" +"%Y-%m-%dT%H:%M:%SZ")"
AUTH_TS="$(date -u +"%Y%m%dT%H:%M:%S+0000")"
NONCE="$(uuidgen 2>/dev/null || openssl rand -hex 16)"
QUERY="product=${PRODUCT}&start=${START_ISO}&end=${END_ISO}"
METHOD="GET"
SCHEME="https"
PATH="$EVENT_PATH"
BODY=""
CONTENT_HASH="$(printf '%s' "$BODY" | openssl dgst -binary -sha256 | base64)"
AUTH_DATA="client_token=${CLIENT_TOKEN};access_token=${ACCESS_TOKEN};timestamp=${AUTH_TS};nonce=${NONCE}"
DECODED_SECRET="$(printf '%s' "$CLIENT_SECRET" | tr -d '\n\r ' | base64 -d 2>/dev/null || true)"
SIGNING_KEY="$(printf '%s' "$AUTH_TS" | openssl dgst -binary -sha256 -mac HMAC -macopt "key:$DECODED_SECRET" | base64)"
TAB=$'\t'
DATA_TO_SIGN="${METHOD}${TAB}${SCHEME}://${HOST}${TAB}${PATH}${TAB}${QUERY}${TAB}${CONTENT_HASH}${TAB}${AUTH_DATA}"
SIG="$(printf '%s' "$DATA_TO_SIGN" | openssl dgst -binary -sha256 -mac HMAC -macopt "key:$(printf '%s' "$SIGNING_KEY" | base64 -d 2>/dev/null)" | base64)"
AUTH_HEADER="EG1-HMAC-SHA256 ${AUTH_DATA};signature=${SIG}"
URL="${SCHEME}://${HOST}${PATH}?${QUERY}"
STAMP="$(date -u +"%Y%m%dT%H%M%SZ")"
OUTFILE="${OUT_DIR%/}/${OUT_PREFIX}_${STAMP}.json"
HTTP_STATUS="$(
  curl -sS -w '%{http_code}' -o "$OUTFILE" \
    -H "Accept: application/json" \
    -H "Authorization: ${AUTH_HEADER}" \
    "$URL"
)"
case "$HTTP_STATUS" in
  2*) : ;;
  *)  echo "Request failed with HTTP $HTTP_STATUS. See $OUTFILE for error JSON." >&2; exit 1 ;;
esac
if command -v jq >/dev/null 2>&1; then
  if jq . "$OUTFILE" >/dev/null 2>&1; then
    tmp="${OUTFILE}.tmp"; jq . "$OUTFILE" >"$tmp" && mv "$tmp" "$OUTFILE"
  fi
fi
echo "Saved events -> $OUTFILE"
