#!/usr/bin/env bash
set -euo pipefail
export PATH=/usr/local/bin:/usr/bin:/bin

CLIENT_TOKEN="akab-REPLACE_ME"
CLIENT_SECRET="REPLACE_ME_BASE64_SECRET"
ACCESS_TOKEN="akab-REPLACE_ME"
HOST="your-subdomain.luna.akamaiapis.net"
EVENT_PATH="/event-viewer-api/v1/events"
PRODUCT="WAF"
TIME_WINDOW_MINUTES=5
OUT_PREFIX="akamai_events"
OUT_DIR="."

END_ISO="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
START_ISO="$(date -u -d "-${TIME_WINDOW_MINUTES} minutes" +"%Y-%m-%dT%H:%M:%SZ")"
AUTH_TS="$(date -u +"%Y%m%dT%H:%M:%S+0000")"
NONCE="$(uuidgen 2>/dev/null || /usr/bin/openssl rand -hex 16)"
QUERY="product=${PRODUCT}&start=${START_ISO}&end=${END_ISO}"

METHOD="GET"
SCHEME="https"
PATH_PART="${EVENT_PATH}"
BODY=""
CONTENT_HASH="$(printf '' | /usr/bin/openssl dgst -binary -sha256 | /usr/bin/openssl base64 -A)"

AUTH_DATA="client_token=${CLIENT_TOKEN};access_token=${ACCESS_TOKEN};timestamp=${AUTH_TS};nonce=${NONCE}"

SECRET_HEX="$(printf '%s' "$CLIENT_SECRET" | tr -d ' \r\n' | /usr/bin/openssl base64 -d -A | xxd -p -c256 | tr -d '\n')"

SIGNING_KEY_HEX="$(
  printf '%s' "$AUTH_TS" \
  | /usr/bin/openssl dgst -binary -sha256 -mac HMAC -macopt "hexkey:${SECRET_HEX}" \
  | xxd -p -c256 | tr -d '\n'
)"

TAB=$'\t'
DATA_TO_SIGN="${METHOD}${TAB}${SCHEME}://${HOST}${TAB}${PATH_PART}${TAB}${QUERY}${TAB}${CONTENT_HASH}${TAB}${AUTH_DATA}"

SIG="$(
  printf '%s' "$DATA_TO_SIGN" \
  | /usr/bin/openssl dgst -binary -sha256 -mac HMAC -macopt "hexkey:${SIGNING_KEY_HEX}" \
  | /usr/bin/openssl base64 -A
)"

AUTH_HEADER="EG1-HMAC-SHA256 ${AUTH_DATA};signature=${SIG}"

URL="${SCHEME}://${HOST}${PATH_PART}?${QUERY}"
STAMP="$(date -u +"%Y%m%dT%H%M%SZ")"
OUTFILE="${OUT_DIR%/}/${OUT_PREFIX}_${STAMP}.json"

HTTP_STATUS="$(
  /usr/bin/curl -sS -w '%{http_code}' -o "$OUTFILE" \
    -H "Host: ${HOST}" \
    -H "Accept: application/json" \
    -H "Authorization: ${AUTH_HEADER}" \
    "$URL"
)"

case "$HTTP_STATUS" in
  2*) : ;;
  *) echo "Request failed with HTTP $HTTP_STATUS. See $OUTFILE"; exit 1 ;;
esac

if command -v jq >/dev/null 2>&1; then
  if jq . "$OUTFILE" >/dev/null 2>&1; then tmp="${OUTFILE}.tmp"; jq . "$OUTFILE" >"$tmp" && mv "$tmp" "$OUTFILE"; fi
fi

echo "Saved events -> $OUTFILE"
