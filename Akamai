#!/usr/bin/env bash
set -euo pipefail

########################################
# 1) CONFIG â€” EDIT THESE VALUES
########################################

# Akamai EdgeGrid credentials
AKAMAI_CLIENT_TOKEN="akab-xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
AKAMAI_CLIENT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"   # base64 string
AKAMAI_ACCESS_TOKEN="akab-xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
AKAMAI_HOST="example.luna.akamaiapis.net"

# API path and parameters
EVENT_PATH="/event-viewer-api/v1/events"
PRODUCT="WAF"                   # Example: WAF, SIEM, etc.
TIME_WINDOW_MINUTES=5           # How many minutes back to pull
OUT_PREFIX="akamai_events"      # Output file prefix

########################################
# 2) TIME WINDOW (UTC)
########################################
now_iso="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
start_iso="$(date -u -d "-${TIME_WINDOW_MINUTES} minutes" +"%Y-%m-%dT%H:%M:%SZ")"

qs="product=$(printf '%s' "$PRODUCT" | jq -sRr @uri)&start=${start_iso}&end=${now_iso}"

########################################
# 3) EDGEGRID SIGNING (EG1-HMAC-SHA256)
########################################
method="GET"
scheme="https"
host="$AKAMAI_HOST"
path="$EVENT_PATH"
query="$qs"
body=""
content_hash="$(printf '%s' "$body" | openssl dgst -binary -sha256 | openssl base64)"
ts_auth="$(date -u +"%Y%m%dT%H:%M:%S+0000")"
nonce="$(uuidgen 2>/dev/null || openssl rand -hex 16)"
auth_data="client_token=${AKAMAI_CLIENT_TOKEN};access_token=${AKAMAI_ACCESS_TOKEN};timestamp=${ts_auth};nonce=${nonce}"

# Signing key = HMAC_SHA256(secret, timestamp)
signing_key="$(printf '%s' "$ts_auth" | \
  openssl dgst -binary -sha256 -mac HMAC -macopt "key:$(printf '%s' "$AKAMAI_CLIENT_SECRET" | openssl base64 -d 2>/dev/null)")"
signing_key_b64="$(printf '%s' "$signing_key" | openssl base64)"

# Data to sign
data_to_sign="${method}\t${scheme}://${host}\t${path}\t${query}\t${content_hash}\t${auth_data}"

# Signature = HMAC_SHA256(signing_key, data_to_sign)
sig="$(printf '%s' "$data_to_sign" | \
  openssl dgst -binary -sha256 -mac HMAC -macopt "key:$(printf '%s' "$signing_key_b64" | openssl base64 -d 2>/dev/null)" | \
  openssl base64)"

authorization="EG1-HMAC-SHA256 ${auth_data};signature=${sig}"

########################################
# 4) API REQUEST + OUTPUT
########################################
url="${scheme}://${host}${path}?${query}"
stamp="$(date -u +"%Y%m%dT%H%M%SZ")"
outfile="${OUT_PREFIX}_${stamp}.json"

echo "Requesting Akamai ${PRODUCT} events from ${start_iso} to ${now_iso}..."

http_status=$(curl -sS -w "%{http_code}" -o "$outfile" \
  -H "Host: ${host}" \
  -H "Authorization: ${authorization}" \
  -H "Accept: application/json" \
  "$url")

if [[ "$http_status" != 2* ]]; then
  echo "Request failed with HTTP ${http_status}. See $outfile for details."
  exit 1
fi

if command -v jq >/dev/null 2>&1; then
  tmp="${outfile}.tmp"
  if jq . "$outfile" >"$tmp" 2>/dev/null; then mv "$tmp" "$outfile"; fi
fi

echo "Saved events to: $outfile"
echo "Window: ${start_iso} .. ${now_iso} (UTC)"
