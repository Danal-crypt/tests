#!/bin/bash

# ------------------------
# Configurable Variables
# ------------------------

SOURCE_HOST="sourcehost.example.com"
DEST_HOST="desthost.example.com"
REMOTE_USER="splunk"

# Full path of the file to be synced on the source server
REMOTE_FILE="/path/to/file.txt"

# Destination directory on the destination server
DEST_DIR="/path/to/destination"

# rsync options
RSYNC_OPTIONS="-avz --stats"

# ------------------------
# Script Logic
# ------------------------

# Step 1: Get password for source and destination
SRC_PASSWORD=$(/opt/password/GetPassword object="${SOURCE_HOST}-splunk" -password 2>/dev/null)
DST_PASSWORD=$(/opt/password/GetPassword object="${DEST_HOST}-splunk" -password 2>/dev/null)

if [[ -z "$SRC_PASSWORD" || -z "$DST_PASSWORD" ]]; then
    echo "[ERROR] Failed to retrieve passwords for one or both servers."
    exit 1
fi

# Step 2: Perform dry-run from SOURCE_HOST to DEST_HOST
echo "Performing dry-run to copy file from $SOURCE_HOST to $DEST_HOST..."
sshpass -p "$SRC_PASSWORD" ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SOURCE_HOST} \
"sshpass -p '$DST_PASSWORD' rsync $RSYNC_OPTIONS --dry-run -e 'ssh -o StrictHostKeyChecking=no' '$REMOTE_FILE' '${REMOTE_USER}@${DEST_HOST}:$DEST_DIR'" 

# Step 3: Confirm action
RANDOM_CODE=$((RANDOM % 9000 + 1000))
echo "If the above dry-run output looks correct, enter this code to confirm the sync: $RANDOM_CODE"

while true; do
    echo -n "Enter code: " > /dev/tty
    read -r user_input < /dev/tty

    if [[ -z "$user_input" ]]; then
        echo "No input detected. Please enter the code." > /dev/tty
        continue
    fi

    echo "You entered: $user_input" > /dev/tty

    if [[ "$user_input" == "$RANDOM_CODE" ]]; then
        echo "Code verified. Proceeding with rsync..." > /dev/tty
        sshpass -p "$SRC_PASSWORD" ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SOURCE_HOST} \
        "sshpass -p '$DST_PASSWORD' rsync $RSYNC_OPTIONS -e 'ssh -o StrictHostKeyChecking=no' '$REMOTE_FILE' '${REMOTE_USER}@${DEST_HOST}:$DEST_DIR'"
        break
    else
        echo "Invalid code. Please try again." > /dev/tty
    fi
done

echo "Script completed."
